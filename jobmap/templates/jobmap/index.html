
{% extends 'base.html' %}
{% block content %}
<div class="container p-4">
  <h2>Job Map</h2>
  <p>Map showing job locations. Markers are added by geocoding job addresses client-side.</p>
  <!-- Form Column -->
  <div class="col-md-3">
    <h4>Your Preferences</h4>
    <hr>

  {% if user.is_authenticated and user.is_seeker %}
  <!-- This form is displayed only to authenticated users -->
  <!-- It passes the user's ID to the update_distance URL -->
  <form method="POST" action="{% url 'jobmap.update_distance'%}">
    {% csrf_token %}
    <div class="mb-3">
      <label for="id_preferred_distance" class="form-label">
        <strong>Preferred Distance (miles)</strong>
      </label>
      <input 
        type="number" 
        name="preferred_distance" 
        class="form-control" 
        id="id_preferred_distance" 
        value="{{ user.distance }}"
        placeholder="e.g. 25"
        required 
      />
    </div>
    <button type="submit" class="btn btn-primary w-100">Update Map</button>
  </form>

  {% else %}
      <!-- This content is shown to unauthenticated (guest) users -->
      <div class="text-center p-4 border rounded bg-light">
          <p class="h5 mb-3">Sign up to get personalized results!</p>
          <p>Create an account to save your preferred distance and see jobs tailored for you.</p>
          <div class="d-grid gap-2 mt-4">
              <!-- Make sure you have URLs named 'signup' and 'login' in your urls.py -->
              <a href="#" class="btn btn-success">Sign Up</a>
              <a href="#" class="btn btn-secondary">Log In</a>
          </div>
      </div>
  {% endif %}

  </div>
  <div id="map" style="height: 600px; width: 100%; border: 1px solid #ddd; margin-top: 1rem;"></div>
</div>

<!-- Mapbox GL JS -->
<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script>
  // Minimal token diagnostics (avoid printing the full token in logs)
  const MAPBOX_KEY = "{{ MAPBOX_KEY }}";
  try {
    console.log('Mapbox token length:', MAPBOX_KEY ? MAPBOX_KEY.length : 0);
    if (MAPBOX_KEY && !MAPBOX_KEY.startsWith('pk.')) {
      console.warn('Mapbox token does not start with "pk." and may be invalid.');
    }
  } catch (e) {
    console.warn('Could not inspect MAPBOX_KEY', e);
  }

  mapboxgl.accessToken = MAPBOX_KEY;

  // Declare `map` in outer scope so other functions can use it.
  let map = null;

  try {
    console.log('Initializing map...');
    map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: [-98.5795, 39.8283], // USA
      zoom: 3
    });

    map.on('style.load', () => {
      console.log('Map style loaded successfully');
    });

    map.on('error', (e) => {
      console.error('Map error:', e);
    });

    // Add navigation controls
    map.addControl(new mapboxgl.NavigationControl());

    console.log('Map initialization complete');
  } catch (e) {
    console.error('Map initialization error:', e);
  }

  const jobs = JSON.parse('{{ jobs_json|escapejs }}');
  console.log('Jobs data (count):', Array.isArray(jobs) ? jobs.length : 'unknown');

  // Geocode each job location and add a marker
  async function addJobMarkers() {
    if (!map) {
      console.warn('Map is not initialized; cannot add markers.');
      return;
    }

    const geocodeBase = 'https://api.mapbox.com/geocoding/v5/mapbox.places/';

    for (const job of jobs) {
      if (!job.location) continue;
      const query = encodeURIComponent(job.location);
      const url = `${geocodeBase}${query}.json?access_token=${MAPBOX_KEY}&limit=1`;

      try {
        const res = await fetch(url);
        if (!res.ok) {
          console.warn('Geocode HTTP error for', job.location, res.status);
          continue;
        }
        const data = await res.json();
        if (data.features && data.features.length > 0) {
          const [lng, lat] = data.features[0].center;
          const popup = new mapboxgl.Popup({ offset: 25 }).setHTML(
            `<strong>${job.title}</strong><br>${job.location}`
          );

          new mapboxgl.Marker()
            .setLngLat([lng, lat])
            .setPopup(popup)
            .addTo(map);
        } else {
          console.log('No geocode result for', job.location);
        }
      } catch (e) {
        console.error('Geocode error for', job.location, e);
      }
    }
  }

  if (map) {
    map.on('load', () => {
      addJobMarkers();
    });
  }
</script>
{% endblock content %}